<!DOCTYPE html>
<html>
<head>
  <title>Title of the document</title>

  <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  <script type="text/javascript">/**
    * jQuery serializeObject
    * @copyright 2014, macek <paulmacek@gmail.com>
    * @link https://github.com/macek/jquery-serialize-object
    * @license BSD
    * @version 2.5.0
    */
   !function(e,i){if("function"==typeof define&&define.amd)define(["exports","jquery"],function(e,r){return i(e,r)});else if("undefined"!=typeof exports){var r=require("jquery");i(exports,r)}else i(e,e.jQuery||e.Zepto||e.ender||e.$)}(this,function(e,i){function r(e,r){function n(e,i,r){return e[i]=r,e}function a(e,i){for(var r,a=e.match(t.key);void 0!==(r=a.pop());)if(t.push.test(r)){var u=s(e.replace(/\[\]$/,""));i=n([],u,i)}else t.fixed.test(r)?i=n([],r,i):t.named.test(r)&&(i=n({},r,i));return i}function s(e){return void 0===h[e]&&(h[e]=0),h[e]++}function u(e){switch(i('[name="'+e.name+'"]',r).attr("type")){case"checkbox":return"on"===e.value?!0:e.value;default:return e.value}}function f(i){if(!t.validate.test(i.name))return this;var r=a(i.name,u(i));return l=e.extend(!0,l,r),this}function d(i){if(!e.isArray(i))throw new Error("formSerializer.addPairs expects an Array");for(var r=0,t=i.length;t>r;r++)this.addPair(i[r]);return this}function o(){return l}function c(){return JSON.stringify(o())}var l={},h={};this.addPair=f,this.addPairs=d,this.serialize=o,this.serializeJSON=c}var t={validate:/^[a-z_][a-z0-9_]*(?:\[(?:\d*|[a-z0-9_]+)\])*$/i,key:/[a-z0-9_]+|(?=\[\])/gi,push:/^$/,fixed:/^\d+$/,named:/^[a-z0-9_]+$/i};return r.patterns=t,r.serializeObject=function(){return new r(i,this).addPairs(this.serializeArray()).serialize()},r.serializeJSON=function(){return new r(i,this).addPairs(this.serializeArray()).serializeJSON()},"undefined"!=typeof i.fn&&(i.fn.serializeObject=r.serializeObject,i.fn.serializeJSON=r.serializeJSON),e.FormSerializer=r,r});</script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>

<style>
  body {
    font-size: 64px;
    margin: 0;
  }

  form {
    display: flex;
    flex-wrap: wrap;
  }

  fieldset {
    display: flex;
    flex-wrap: wrap;
    padding: 1em;
    margin: 1em;
    flex-basis: 100%;
  }

  input {
    font-size: 64px;
  }

  input[type="text"], input[type="date"] {
    height: 2em;
    text-align: center;
    padding: 0.8em;
    margin: 1em 0;
    width: 100%;
  }

  input[type="radio"] {
    -ms-transform: translate(-5px, -5px)  scale(4); /* IE 9 */
    -webkit-transform: translate(-5px, -5px)  scale(4); /* Chrome, Safari, Opera */
    transform:  translate(-5px, -5px) scale(4);
    margin: 0 1em;
  }

  textarea {
    height: 400px;
    width: 100%;
  }

  button {
    padding: 1em;
    margin: 1em 1em 2em;
    font-size: 64px;
    width: 100%;
  }
</style>

<body>
  <form id="rounds_form">
    <fieldset name="shift_metadata">
      <legend>Shift Information</legend>
      <input type="text" name="shift" placeholder="Shift">
      <input type="text" name="initials" placeholder="Initials">
      <input type="text" name="start_time" placeholder="Start Time (HHMM)">
      <input type="date" name="date">
      <button id="reset_form_button">Reset Form</button>
    </fieldset>

    <fieldset name="dca">
      <legend>DCA</legend>
      <input type="text" inputmode="numeric" name="dca[temperature]" placeholder="Temperature">
      <input type="text" inputmode="numeric" name="dca[humidity]" placeholder="Humidity">
    </fieldset>

    <fieldset name="l3">
      <legend>L3</legend>
      <input type="text" inputmode="numeric" name="l3[temperature]" placeholder="Temperature">
      <input type="text" inputmode="numeric" name="l3[humidity]" placeholder="Humidity">
      <input type="text" inputmode="numeric" name="l3[cooling]" placeholder="Cooling">
      <input type="text" inputmode="numeric" name="l3[free_cooling]" placeholder="Free Cooling">
    </fieldset>

    <fieldset name="l1">
      <legend>L1</legend>
      <input type="text" inputmode="numeric" name="l1[temperature]" placeholder="Temperature">
      <input type="text" inputmode="numeric" name="l1[humidity]" placeholder="Humidity">
      <input type="text" inputmode="numeric" name="l1[cooling]" placeholder="Cooling">
      <input type="text" inputmode="numeric" name="l1[free_cooling]" placeholder="Free Cooling">
    </fieldset>

    <fieldset name="aisle">
      <legend>Aisle</legend>
      <input type="text" inputmode="numeric" name="aisle[temperature]" placeholder="Temperature">
      <input type="text" inputmode="numeric" name="aisle[humidity]" placeholder="Humidity">
    </fieldset>

    <fieldset name="l2">
      <legend>L2</legend>
      <input type="text" inputmode="numeric" name="l2[temperature]" placeholder="Temperature">
      <input type="text" inputmode="numeric" name="l2[humidity]" placeholder="Humidity">
      <input type="text" inputmode="numeric" name="l2[cooling]" placeholder="Cooling">
      <input type="text" inputmode="numeric" name="l2[free_cooling]" placeholder="Free Cooling">
      <div>
        <label for="active_crac">Is active CRAC</label>
        <input type="radio" name="active_crac" value="l2" checked>
      </div>
    </fieldset>

    <fieldset name="dcb">
      <legend>DCB</legend>
      <input type="text" inputmode="numeric" name="dcb[temperature]" placeholder="Temperature">
      <input type="text" inputmode="numeric" name="dcb[humidity]" placeholder="Humidity">
    </fieldset>

    <fieldset name="l7">
      <legend>L7</legend>
      <input type="text" inputmode="numeric" name="l7[temperature]" placeholder="Temperature">
      <input type="text" inputmode="numeric" name="l7[humidity]" placeholder="Humidity">
      <input type="text" inputmode="numeric" name="l7[cooling]" placeholder="Cooling">
      <input type="text" inputmode="numeric" name="l7[free_cooling]" placeholder="Free Cooling">
      <div>
        <label for="active_crac">Is active CRAC</label>
        <input type="radio" name="active_crac" value="l7">
      </div>
    </fieldset>

    <fieldset name="stultz">
      <legend>Stultz</legend>
      <input type="text" inputmode="numeric" name="stultz[temperature]" placeholder="Temperature">
      <input type="text" inputmode="numeric" name="stultz[humidity]" placeholder="Humidity">
    </fieldset>

    <fieldset name="dcd">
      <legend>DCD</legend>
      <input type="text" inputmode="numeric" name="dcd[temperature]" placeholder="Temperature">
      <input type="text" inputmode="numeric" name="dcd[humidity]" placeholder="Humidity">
    </fieldset>

    <fieldset name="dmarc_b">
      <legend>DMARC B</legend>
      <input type="text" inputmode="numeric" name="dmarc_b[temperature]" placeholder="Temperature">
      <input type="text" inputmode="numeric" name="dmarc_b[humidity]" placeholder="Humidity">
    </fieldset>

    <fieldset name="ups_b">
      <legend>UPS B</legend>
      <input type="text" inputmode="numeric" name="ups_b[temperature]" placeholder="Temperature">
      <input type="text" inputmode="numeric" name="ups_b[humidity]" placeholder="Humidity">
      <input type="text" inputmode="numeric" name="ups_b[second_temp]" placeholder="Second Temperature">
    </fieldset>

    <fieldset name="ceiling_temp">
      <legend>Ceiling Temps</legend>
      <input type="text" inputmode="numeric" name="ceiling_temp[temperature][0]" placeholder="Temperature 1">
      <input type="text" inputmode="numeric" name="ceiling_temp[temperature][1]" placeholder="Temperature 2">
      <input type="text" inputmode="numeric" name="ceiling_temp[temperature][2]" placeholder="Temperature 3">
      <input type="text" inputmode="numeric" name="ceiling_temp[temperature][3]" placeholder="Temperature 4">
    </fieldset>

    <fieldset name="glycol_pumps">
      <legend>Glycol Pumps</legend>
      <div>
        <label for="glycol_pumps[active]">P1</label>
        <input type="radio" name="glycol_pumps[active]" value="p1" placeholder="P1" checked>
        <label for="glycol_pumps[active]">P2</label>
        <input type="radio" name="glycol_pumps[active]" value="p2" placeholder="P2">
      </div>
      <input type="text" inputmode="numeric" name="glycol_pumps[pressure]" placeholder="Pump Pressure">
      <input type="text" inputmode="numeric" name="glycol_pumps[outside_temp]" placeholder="Outside Temp">
    </fieldset>

    <fieldset name="dmarc_a">
      <legend>DMARC A</legend>
      <input type="text" inputmode="numeric" name="dmarc_a[temperature]" placeholder="Temperature">
      <input type="text" inputmode="numeric" name="dmarc_a[humidity]" placeholder="Humidity">
    </fieldset>

    <fieldset name="ups_a">
      <legend>UPS A</legend>
      <input type="text" inputmode="numeric" name="ups_a[temperature]" placeholder="Temperature">
      <input type="text" inputmode="numeric" name="ups_a[humidity]" placeholder="Humidity">
      <input type="text" inputmode="numeric" name="ups_a[second_temp]" placeholder="Second Temperature">
    </fieldset>

    <fieldset name="notes">
      <legend>Notes</legend>
      <input type="text" name="notes" style="height: 400px;"></textarea>
    </fieldset>

    <button type="submit">SUBMIT</button>
  </form>
  
  <script type="text/javascript">
    // VIEWS
    var parentForm = document.getElementById("rounds_form");

    // SHIFT INPUT
    // Auto set shift
    var shiftInput = parentForm.querySelector("input[name='shift']");

    function getCurrentShift() {
      var setDateTime = function(date, str){
        var sp = str.split(':');
        date.setHours(parseInt(sp[0],10));
        date.setMinutes(parseInt(sp[1],10));
        date.setSeconds(parseInt(sp[2],10));
        return date;
      }
  
      var current = new Date();
  
      var cT = current.getTime();
  
      // First Shift
      var first_start = setDateTime(new Date(current), '7:00:00');
      var first_end = setDateTime(new Date(current), '15:30:00');
  
      // Second Shift
      var second_start = setDateTime(new Date(current), '15:00:00');
      var second_end = setDateTime(new Date(current), '23:30:00');
  
      // Third Shift
      var third_start = setDateTime(new Date(current), '23:00:00');
      var third_end = setDateTime(new Date(current), '7:30:00');
  
      var curr_shift = "1st";
      if (first_start < cT < first_end) {
        curr_shift = "1st";
      } else if (second_start < cT < second_end) {
        curr_shift = "2nd";
      } else /*if (third_start < cT < third_end)*/ {
        curr_shift = "3rd";
      }

      return curr_shift
    }

    shiftInput.value = getCurrentShift();
    // SHIFT INPUT

    // DATE INPUT
    // Set date to current date
    var dateInput = parentForm.querySelector("input[name='date']");
    dateInput.valueAsDate = new Date();
    // DATE INPUT

    // Rounds Start time INPUT
    var startTimeInput = parentForm.querySelector("input[name='start_time']");

    function getTimeHHMM() {
      var startTimeDateObject = new Date();

      return ("0" + startTimeDateObject.getHours()).slice(-2) + "" + ("0" + startTimeDateObject.getMinutes()).slice(-2);
    }
    startTimeInput.value = getTimeHHMM();

    // Rounds Start time INPUT

    var reset_button = document.getElementById("reset_form_button");
    reset_button.addEventListener("click", (e) => {
      e.preventDefault();
      // Reset the form data
      parentForm.reset();
      // Clear session data
      sessionStorage.removeItem("form_data");

      // Reset Date input
      dateInput.valueAsDate = new Date();
      // Reset TimeInput
      startTimeInput.value = getTimeHHMM();
      // Reset Shift
      shiftInput.value = getCurrentShift();
    });

    // END VIEWS

    // FORM Data Tracking
    window.addEventListener("load", (e) => {
      // Check for session data
      var form_data_json = sessionStorage.getItem("form_data");

      if (form_data_json) {
        var form_data = JSON.parse(form_data_json);
        console.log(form_data);

        for (var inputName in form_data) {
          if (typeof form_data[inputName] == "object") {
            // find each input in the object list and fill the data if it exists
            for (var inputField in form_data[inputName]) {
              if (Array.isArray(form_data[inputName][inputField])) {
                for (var inputIndex in form_data[inputName][inputField]) {
                  var _$input = $(`input[name="${inputName}[${inputField}][${inputIndex}]"]`);
                  _$input.val(form_data[inputName][inputField][inputIndex]);
                }
              } else {
                if (form_data[inputName][inputField].length) {
                  var _$input = $(`input[name="${inputName}[${inputField}]"]`);
                  
                  if (_$input.attr("type") == "radio") {
                    _$input.removeAttr("checked");

                    _$input.siblings(`[value='${form_data[inputName][inputField]}']`).attr("checked", true);
                  } else {
                    _$input.val(form_data[inputName][inputField]);
                  }
                }
              }
            }
          } else {
            // find the input and fill the value if it exists
            if (form_data[inputName].length) {
              var _$input = $(`input[name="${inputName}"]`);

              if (_$input.attr("type") == "radio") {
                _$input.removeAttr("checked");

                _$input.siblings(`[value='${form_data[inputName]}']`).attr("checked", true);
              } else {  
                _$input.val(form_data[inputName]);
              }
            }
          }
        }
      }
    });

    // Save form Session data
    window.addEventListener("beforeunload", (e) => {
      var form_data = JSON.stringify($(parentForm).serializeObject());
      sessionStorage.setItem("form_data", form_data);
    });

    // FORM SUBMIT
    var submitButton = parentForm.querySelector("button[type='submit']");

    submitButton.addEventListener("click", function(e) {
      e.preventDefault();
      
      var form_data = $(parentForm).serializeObject();
      console.log(form_data);
      
      // WORKBOOK
      var tdc_operations_rounds_workbook = XLSX.utils.book_new();

      /**
       * Creates the named worksheet with the passed sheet data and appends
       * it to the passed workbook
       * 
       * @param string sheetName Name of the sheet you want to create
       * @param array  sheetData Row data to be added into the sheet
       * @param object workbook  XLSX workbook to append the created sheet to
       * 
       */
      function createAppendWorksheet(sheetName, sheetData, workbook) {
        console.log(sheetData)

        var worksheet = XLSX.utils.json_to_sheet(sheetData);
        XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
      }

      // sheets
      // DC A
      // data required - dca - l3 - l1 - aisle
      var dc_a_worksheet_row_data = [
        {
          "dca_temperature": form_data.dca.temperature,
          "dca_humidity": form_data.dca.humidity,
          "l3_temperature": form_data.l3.temperature,
          "l3_humidity": form_data.l3.humidity,
          "l3_free_cooling": form_data.l3.free_cooling,
          "l3_cooling": form_data.l3.cooling,
          "l1_temperature": form_data.l1.temperature,
          "l1_humidity": form_data.l1.humidity,
          "l1_free_cooling": form_data.l1.free_cooling,
          "l1_cooling": form_data.l1.cooling,
          "aisle_temperature": form_data.aisle.temperature,
          "aisle_humidity": form_data.aisle.humidity
        }
      ];

      createAppendWorksheet("DC A", dc_a_worksheet_row_data, tdc_operations_rounds_workbook);

      // DC B
      // data required - dcb - l7 -l2
      var dc_b_worksheet_row_data = [
        {
          "dcb_temperature": form_data.dcb.temperature,
          "dcb_humidity": form_data.dcb.humidity,
          "l7_temperature": form_data.l7.temperature,
          "l7_humidity": form_data.l7.humidity,
          "l7_cooling": form_data.l7.cooling,
          "l7_free_cooling": form_data.l7.free_cooling,
          "l2_temperature": form_data.l2.temperature,
          "l2_humidity": form_data.l2.humidity,
          "l2_cooling": form_data.l2.cooling,
          "l2_free_cooling": form_data.l2.free_cooling,
          "active_crac": form_data.active_crac
        }
      ];

      createAppendWorksheet("DC B", dc_b_worksheet_row_data, tdc_operations_rounds_workbook);

      // DC D
      // data required - dcd - stultz
      var dc_d_worksheet_row_data = [
        {
          "stultz_temperature": form_data.stultz.temperature,
          "stultz_humidity": form_data.stultz.humidity,
          "dcd_temperature": form_data.dcd.temperature,
          "dcd_humidity": form_data.dcd.humidity
        }
      ];
      
      createAppendWorksheet("DC D", dc_d_worksheet_row_data, tdc_operations_rounds_workbook);

      // UPS A
      // data required - ups_a
      var ups_a_worksheet_row_data = [
        {
          "ups_a_temperature": form_data.ups_a.temperature,
          "ups_a_humidity": form_data.ups_a.humidity,
          "ups_a_second_temp": form_data.ups_a.second_temp
        }
      ];

      createAppendWorksheet("UPS A", ups_a_worksheet_row_data, tdc_operations_rounds_workbook);

      // UPS B
      // data required - ups_b
      var ups_b_worksheet_row_data = [
        {
          "ups_b_temperature": form_data.ups_b.temperature,
          "ups_b_humidity": form_data.ups_b.humidity,
          "ups_b_second_temp": form_data.ups_b.second_temp
        }
      ];

      createAppendWorksheet("UPS B", ups_b_worksheet_row_data, tdc_operations_rounds_workbook);

      // Demarc A
      // data required - dmarc_a
      var dmarc_a_worksheet_row_data = [
        {
          "dmarc_a_temperature": form_data.dmarc_a.temperature,
          "dmarc_a_humidity": form_data.dmarc_a.humidity
        }
      ];

      createAppendWorksheet("Demarc A", dmarc_a_worksheet_row_data, tdc_operations_rounds_workbook);

      // Demarc B
      // data required - dmarc_b
      var dmarc_b_worksheet_row_data = [
        {
          "dmarc_b_temperature": form_data.dmarc_b.temperature,
          "dmarc_b_humidity": form_data.dmarc_b.humidity
        }
      ];

      createAppendWorksheet("Demarc B", dmarc_b_worksheet_row_data, tdc_operations_rounds_workbook);

      // Glycol Pumps
      // data required - glycol_pumps - ceiling_temp
      var p1_pump_status = form_data.glycol_pumps.active == "p1" ? "x" : "o";
      var p2_pump_status = form_data.glycol_pumps.active == "p2" ? "x" : "o";

      var glycol_pumps_worksheet_row_data = [
        {
          "p1": p1_pump_status,
          "p2": p2_pump_status,
          "pressure": form_data.glycol_pumps.pressure,
          "outside_temp": form_data.glycol_pumps.outside_temp,
          "ceiling_temp1": form_data.ceiling_temp.temperature[0],
          "ceiling_temp2": form_data.ceiling_temp.temperature[1],
          "ceiling_temp3": form_data.ceiling_temp.temperature[2],
          "ceiling_temp4": form_data.ceiling_temp.temperature[3],
          "time/initials": form_data.initials + " " + form_data.start_time,
          "NOTES": form_data.notes
        }
      ];
      
      createAppendWorksheet("Glycol Pumps", glycol_pumps_worksheet_row_data, tdc_operations_rounds_workbook);
      
      // EXPORT WORKBOOK
      var save_date = new Date();
      XLSX.writeFile(tdc_operations_rounds_workbook, "TDC_Operations_Rounds_" + save_date.getMonth() + "_" + save_date.getDate() + "_" + save_date.getFullYear() + ".xlsx", { compression: true });

      // Clean up session data
      sessionStorage.removeItem("form_data");
    });
  </script>
</body>

</html>
