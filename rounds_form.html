<!DOCTYPE html>
<html>
<head>
  <title>Title of the document</title>

  <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  <script type="text/javascript">/**
    * jQuery serializeObject
    * @copyright 2014, macek <paulmacek@gmail.com>
    * @link https://github.com/macek/jquery-serialize-object
    * @license BSD
    * @version 2.5.0
    */
   !function(e,i){if("function"==typeof define&&define.amd)define(["exports","jquery"],function(e,r){return i(e,r)});else if("undefined"!=typeof exports){var r=require("jquery");i(exports,r)}else i(e,e.jQuery||e.Zepto||e.ender||e.$)}(this,function(e,i){function r(e,r){function n(e,i,r){return e[i]=r,e}function a(e,i){for(var r,a=e.match(t.key);void 0!==(r=a.pop());)if(t.push.test(r)){var u=s(e.replace(/\[\]$/,""));i=n([],u,i)}else t.fixed.test(r)?i=n([],r,i):t.named.test(r)&&(i=n({},r,i));return i}function s(e){return void 0===h[e]&&(h[e]=0),h[e]++}function u(e){switch(i('[name="'+e.name+'"]',r).attr("type")){case"checkbox":return"on"===e.value?!0:e.value;default:return e.value}}function f(i){if(!t.validate.test(i.name))return this;var r=a(i.name,u(i));return l=e.extend(!0,l,r),this}function d(i){if(!e.isArray(i))throw new Error("formSerializer.addPairs expects an Array");for(var r=0,t=i.length;t>r;r++)this.addPair(i[r]);return this}function o(){return l}function c(){return JSON.stringify(o())}var l={},h={};this.addPair=f,this.addPairs=d,this.serialize=o,this.serializeJSON=c}var t={validate:/^[a-z_][a-z0-9_]*(?:\[(?:\d*|[a-z0-9_]+)\])*$/i,key:/[a-z0-9_]+|(?=\[\])/gi,push:/^$/,fixed:/^\d+$/,named:/^[a-z0-9_]+$/i};return r.patterns=t,r.serializeObject=function(){return new r(i,this).addPairs(this.serializeArray()).serialize()},r.serializeJSON=function(){return new r(i,this).addPairs(this.serializeArray()).serializeJSON()},"undefined"!=typeof i.fn&&(i.fn.serializeObject=r.serializeObject,i.fn.serializeJSON=r.serializeJSON),e.FormSerializer=r,r});</script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>

<body>
  <form id="rounds_form">
    <fieldset name="shift_metadata">
      <legend>Shift Information</legend>
      <input type="text" name="shift" placeholder="Shift">
      <input type="text" name="initials" placeholder="Initials">
      <input type="text" name="start_time" placeholder="Start Time (HHMM)">
      <input type="date" name="date">
    </fieldset>

    <fieldset name="dca">
      <legend>DCA</legend>
      <input type="text" name="dca[temperature]" placeholder="Temperature">
      <input type="text" name="dca[humidity]" placeholder="Humidity">
    </fieldset>

    <fieldset name="l3">
      <legend>L3</legend>
      <input type="text" name="l3[temperature]" placeholder="Temperature">
      <input type="text" name="l3[humidity]" placeholder="Humidity">
      <input type="text" name="l3[cooling]" placeholder="Cooling">
      <input type="text" name="l3[free_cooling]" placeholder="Free Cooling">
    </fieldset>

    <fieldset name="l1">
      <legend>L1</legend>
      <input type="text" name="l1[temperature]" placeholder="Temperature">
      <input type="text" name="l1[humidity]" placeholder="Humidity">
      <input type="text" name="l1[cooling]" placeholder="Cooling">
      <input type="text" name="l1[free_cooling]" placeholder="Free Cooling">
    </fieldset>

    <fieldset name="aisle">
      <legend>Aisle</legend>
      <input type="text" name="aisle[temperature]" placeholder="Temperature">
      <input type="text" name="aisle[humidity]" placeholder="Humidity">
    </fieldset>

    <fieldset name="l2">
      <legend>L2</legend>
      <input type="text" name="l2[temperature]" placeholder="Temperature">
      <input type="text" name="l2[humidity]" placeholder="Humidity">
      <input type="text" name="l2[cooling]" placeholder="Cooling">
      <input type="text" name="l2[free_cooling]" placeholder="Free Cooling">
    </fieldset>

    <fieldset name="dcb">
      <legend>DCB</legend>
      <input type="text" name="dcb[temperature]" placeholder="Temperature">
      <input type="text" name="dcb[humidity]" placeholder="Humidity">
    </fieldset>

    <fieldset name="l7">
      <legend>L7</legend>
      <input type="text" name="l7[temperature]" placeholder="Temperature">
      <input type="text" name="l7[humidity]" placeholder="Humidity">
      <input type="text" name="l7[cooling]" placeholder="Cooling">
      <input type="text" name="l7[free_cooling]" placeholder="Free Cooling">
    </fieldset>

    <fieldset name="stultz">
      <legend>Stultz</legend>
      <input type="text" name="stultz[temperature]" placeholder="Temperature">
      <input type="text" name="stultz[humidity]" placeholder="Humidity">
    </fieldset>

    <fieldset name="dcd">
      <legend>DCD</legend>
      <input type="text" name="dcd[temperature]" placeholder="Temperature">
      <input type="text" name="dcd[humidity]" placeholder="Humidity">
    </fieldset>

    <fieldset name="dmarc_b">
      <legend>DMARC B</legend>
      <input type="text" name="dmarc_b[temperature]" placeholder="Temperature">
      <input type="text" name="dmarc_b[humidity]" placeholder="Humidity">
    </fieldset>

    <fieldset name="ups_b">
      <legend>UPS B</legend>
      <input type="text" name="ups_b[temperature]" placeholder="Temperature">
      <input type="text" name="ups_b[humidity]" placeholder="Humidity">
      <input type="text" name="ups_b[second_temp]" placeholder="Second Temperature">
    </fieldset>

    <fieldset name="ceiling_temp">
      <legend>Ceiling Temps</legend>
      <input type="text" name="ceiling_temp[temperature][]" placeholder="Temperature 1">
      <input type="text" name="ceiling_temp[temperature][]" placeholder="Temperature 2">
      <input type="text" name="ceiling_temp[temperature][]" placeholder="Temperature 3">
      <input type="text" name="ceiling_temp[temperature][]" placeholder="Temperature 4">
    </fieldset>

    <fieldset name="glycol_pumps">
      <legend>Glycol Pumps</legend>
      <label for="glycol_pumps[active]">P1</label>
      <input type="radio" name="glycol_pumps[active]" value="p1" placeholder="P1" checked>
      <label for="glycol_pumps[active]">P2</label>
      <input type="radio" name="glycol_pumps[active]" value="p2" placeholder="P2">
      <input type="text" name="glycol_pumps[pressure]" placeholder="Pump Pressure">
      <input type="text" name="glycol_pumps[outside_temp]" placeholder="Outside Temp">
    </fieldset>

    <fieldset name="dmarc_a">
      <legend>DMARC A</legend>
      <input type="text" name="dmarc_a[temperature]" placeholder="Temperature">
      <input type="text" name="dmarc_a[humidity]" placeholder="Humidity">
    </fieldset>

    <fieldset name="ups_a">
      <legend>UPS A</legend>
      <input type="text" name="ups_a[temperature]" placeholder="Temperature">
      <input type="text" name="ups_a[humidity]" placeholder="Humidity">
      <input type="text" name="ups_a[second_temp]" placeholder="Second Temperature">
    </fieldset>

    <button type="submit">SUBMIT</button>
  </form>
  
  <script type="text/javascript">
    // VIEWS
    var parentForm = document.getElementById("rounds_form");

    // SHIFT INPUT
    // Auto set shift
    var shiftInput = parentForm.querySelector("input[name='shift']");

    var setDateTime = function(date, str){
      var sp = str.split(':');
      date.setHours(parseInt(sp[0],10));
      date.setMinutes(parseInt(sp[1],10));
      date.setSeconds(parseInt(sp[2],10));
      return date;
    }

    var current = new Date();

    var cT = current.getTime();

    // First Shift
    var first_start = setDateTime(new Date(current), '7:00:00');
    var first_end = setDateTime(new Date(current), '15:30:00');

    // Second Shift
    var second_start = setDateTime(new Date(current), '15:00:00');
    var second_end = setDateTime(new Date(current), '23:30:00');

    // Third Shift
    var third_start = setDateTime(new Date(current), '23:00:00');
    var third_end = setDateTime(new Date(current), '7:30:00');

    var curr_shift = "1st";
    if (first_start < cT < first_end) {
      curr_shift = "1st";
    } else if (second_start < cT < second_end) {
      curr_shift = "2nd";
    } else /*if (third_start < cT < third_end)*/ {
      curr_shift = "3rd";
    }

    shiftInput.value = curr_shift;
    // SHIFT INPUT

    // DATE INPUT
    // Set date to current date
    var dateInput = parentForm.querySelector("input[name='date']");
    dateInput.valueAsDate = new Date();
    // DATE INPUT

    // Rounds Start time INPUT
    var startTimeInput = parentForm.querySelector("input[name='start_time']");
    var startTimeDateObject = new Date();
    startTimeInput.value = ("0" + startTimeDateObject.getHours()).slice(-2) + "" + ("0" + startTimeDateObject.getMinutes()).slice(-2);

    // Rounds Start time INPUT

    // END VIEWS

    // FORM SUBMIT
    var submitButton = parentForm.querySelector("button[type='submit']");

    submitButton.addEventListener("click", function(e) {
      e.preventDefault();
      
      var form_data = $(parentForm).serializeObject();
      console.log(form_data);
      
      // WORKBOOK
      var tdc_operations_rounds_workbook = XLSX.utils.book_new();

      function createAppendWorksheet(sheetName, sheetData, workbook) {
        console.log(sheetData)

        var worksheet = XLSX.utils.json_to_sheet(sheetData);
        XSLX.utils.book_append_sheet(workbook, worksheet, sheetName);
      }

      // sheets
      // DC A
      // data required - dca - l3 - l1 - aisle
      var dc_a_worksheet_row_data = [
        {
          "dca_temperature": form_data.dca.temperature,
          "dca_humidity": form_data.dca.humidity,
          "l3_temperature": form_data.l3.temperature,
          "l3_humidity": form_data.l3.humidity,
          "l3_free_cooling": form_data.l3.free_cooling,
          "l3_cooling": form_data.l3.cooling,
          "l1_temperature": form_data.l1.temperature,
          "l1_humidity": form_data.l1.humidity,
          "l1_free_cooling": form_data.l1.free_cooling,
          "l1_cooling": form_data.l1.cooling,
          "aisle_temperature": form_data.aisle.temperature,
          "aisle_humidity": form_data.aisle.humidity
        }
      ];

      createAppendWorksheet("DC A", dc_a_worksheet_row_data, tdc_operations_rounds_workbook);
      // var dc_a_worksheet = XLSX.utils.json_to_sheet(dc_a_worksheet_row_data);
      // console.log(dc_a_worksheet);

      // XLSX.utils.book_append_sheet(tdc_operations_rounds_workbook, dc_a_worksheet, "DC A");

      // DC B
      // data required - dcb - l7 -l2
      var dc_b_worksheet_row_data = [
        {
          "dcb_temperature": form_data.dcb.temperature,
          "dcb_humidity": form_data.dcb.humidity,
          "l7_temperature": form_data.l7.temperature,
          "l7_humidity": form_data.l7.humidity,
          "l7_cooling": form_data.l7.cooling,
          "l7_free_cooling": form_data.l7.free_cooling,
          "l2_temperature": form_data.l2.temperature,
          "l2_humidity": form_data.l2.humidity,
          "l2_cooling": form_data.l2.cooling,
          "l2_free_cooling": form_data.l2.free_cooling
        }
      ];

      createAppendWorksheet("DC B", dc_b_worksheet_row_data, tdc_operations_rounds_workbook);

      // console.log(dc_b_worksheet_row_data);
      // var dc_b_worksheet = XLSX.utils.json_to_sheet(dc_b_worksheet_row_data);

      // XLSX.utils.book_append_sheet(tdc_operations_rounds_workbook, dc_b_worksheet, "DC B");

      // DC D
      // data required - dcd - stultz
      var dc_d_worksheet_row_data = [
        {
          "stultz_temperature": form_data.stultz.temperature,
          "stultz_humidity": form_data.stultz.humidity,
          "dcd_temperature": form_data.dcd.temperature,
          "dcd_humidity": form_data.dcd.humidity
        }
      ];
      
      createAppendWorksheet("DC D", dc_d_worksheet_row_data, tdc_operations_rounds_workbook);
      // console.log(dc_d_worksheet_row_data);
      // var dc_d_worksheet = XLSX.utils.json_to_sheet(dc_d_worksheet_row_data);
      // XLSX.utils.book_append_sheet(tdc_operations_rounds_workbook, dc_d_worksheet, "DC D");

      // UPS A
      // data required - ups_a
      var ups_a_worksheet_row_data = [
        {
          "ups_a_temperature": form_data.ups_a.temperature,
          "ups_a_humidity": form_data.ups_a.humidity,
          "ups_a_second_temp": form_data.ups_a.second_temp
        }
      ];

      createAppendWorksheet("UPS A", ups_a_worksheet_row_data, tdc_operations_rounds_workbook);

      // console.log(ups_a_worksheet_row_data);
      // var ups_a_worksheet = XLSX.utils.json_to_sheet(ups_a_worksheet_row_data);
      // XLSX.utils.book_append_sheet(tdc_operations_rounds_workbook, ups_a_worksheet, "UPS A");

      // UPS B
      // data required - ups_b
      var ups_b_worksheet_row_data = [
        {
          "ups_b_temperature": form_data.ups_b.temperature,
          "ups_b_humidity": form_data.ups_b.humidity,
          "ups_b_second_temp": form_data.ups_b.second_temp
        }
      ];

      createAppendWorksheet("UPS B", ups_b_worksheet_row_data, tdc_operations_rounds_workbook);

      // console.log(ups_b_worksheet_row_data);
      // var ups_b_worksheet = XLSX.utils.json_to_sheet(ups_b_worksheet_row_data);
      // XLSX.utils.book_append_sheet(tdc_operations_rounds_workbook, ups_b_worksheet, "UPS B");

      // Demarc A
      // data required - dmarc_a
      var dmarc_a_worksheet_row_data = [
        {
          "dmarc_a_temperature": form_data.dmarc_a.temperature,
          "dmarc_a_humidity": form_data.dmarc_a.humidity
        }
      ];

      createAppendWorksheet("Demarc A", dmarc_a_worksheet_row_data, tdc_operations_rounds_workbook);

      // console.log(dmarc_a_worksheet_row_data);
      // var dmarc_a_worksheet = XLSX.utils.json_to_sheet(dmarc_a_worksheet_row_data);
      // XLSX.utils.book_append_sheet(tdc_operations_rounds_workbook, dmarc_a_worksheet, "Demarc A");

      // Demarc B
      // data required - dmarc_b
      var dmarc_b_worksheet_row_data = [
        {
          "dmarc_b_temperature": form_data.dmarc_b.temperature,
          "dmarc_b_humidity": form_data.dmarc_b.humidity
        }
      ];

      createAppendWorksheet("Demarc B", dmarc_b_worksheet_row_data, tdc_operations_rounds_workbook);

      // console.log(dmarc_b_worksheet_row_data);
      // var dmarc_b_worksheet = XLSX.utils.json_to_sheet(dmarc_b_worksheet_row_data);
      // XLSX.utils.book_append_sheet(tdc_operations_rounds_workbook, dmarc_b_worksheet, "Demarc B");

      // Glycol Pumps
      // data required - glycol_pumps - ceiling_temp
      var p1_pump_status = form_data.glycol_pumps.active == "p1" ? "x" : "o";
      var p2_pump_status = form_data.glycol_pumps.active == "p2" ? "x" : "o";

      var glycol_pumps_worksheet_row_data = [
        {
          "p1": p1_pump_status,
          "p2": p2_pump_status,
          "pressure": form_data.glycol_pumps.pressure,
          "outside_temp": form_data.glycol_pumps.outside_temp,
          "ceiling_temp1": form_data.ceiling_temp.temperature[1],
          "ceiling_temp2": form_data.ceiling_temp.temperature[2],
          "ceiling_temp3": form_data.ceiling_temp.temperature[3],
          "ceiling_temp4": form_data.ceiling_temp.temperature[4],
          "time/initials": form_data.initials + " " + form_data.start_time
        }
      ];
      
      createAppendWorksheet("Glycol Pumps", glycol_pumps_worksheet_row_data, tdc_operations_rounds_workbook);

      // console.log(glycol_pumps_worksheet_row_data);
      // var glycol_pumps_worksheet = XLSX.utils.json_to_sheet(glycol_pumps_worksheet_row_data);
      // XLSX.utils.book_append_sheet(tdc_operations_rounds_workbook, glycol_pumps_worksheet, "Glycol Pumps");
      
      // EXPORT WORKBOOK
      var save_date = new Date();
      XLSX.writeFile(tdc_operations_rounds_workbook, "TDC_Operations_Rounds_" + save_date.getMonth() + "_" + save_date.getDate() + "_" + save_date.getFullYear() + ".xlsx", { compression: true });
    });

    // XLSX
    // XLSX
  </script>
</body>

</html>
